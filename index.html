<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² Dice Vestor: Multi-Lab</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Roboto Mono', monospace; user-select: none; }
        .font-title { font-family: 'Black Han Sans', sans-serif; }
        .hidden-screen { display: none !important; }
        
        /* ì£¼ì‚¬ìœ„ */
        .die {
            width: 50px; height: 50px;
            background: linear-gradient(145deg, #ffffff, #e2e8f0); color: #1e293b;
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold; box-shadow: 0 4px 0 #94a3b8;
            cursor: pointer; transition: transform 0.1s;
        }
        .die.locked { background: #ef4444; color: white; box-shadow: 0 4px 0 #991b1b; transform: translateY(4px); }
        .die-lg { width: 80px; height: 80px; font-size: 2.5rem; } /* í° ì£¼ì‚¬ìœ„ */
        .rolling { animation: shake 0.4s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }

        /* í”Œë ˆì´ì–´ ì¹´ë“œ */
        .player-card { border: 2px solid #334155; padding: 10px; border-radius: 10px; opacity: 0.7; transition: all 0.3s; }
        .player-card.active-turn { border-color: #fbbf24; background-color: #334155; opacity: 1; transform: scale(1.05); box-shadow: 0 0 15px rgba(251, 191, 36, 0.3); }
        .player-card.is-me { border-color: #3b82f6; }
    </style>
</head>
<body class="h-screen flex items-center justify-center overflow-hidden">

    <div id="screen-menu" class="w-full max-w-md p-8 bg-gray-800 rounded-2xl border border-gray-700 shadow-2xl text-center">
        <h1 class="text-5xl font-title text-yellow-400 mb-2">ğŸ² DICE VESTOR</h1>
        <p class="text-gray-400 mb-8">í™•ë¥ ê³¼ í†µê³„ & íˆ¬ì ì‹œë®¬ë ˆì´ì…˜</p>
        
        <div class="space-y-4">
            <button onclick="startSinglePlayer()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg transition">
                ğŸ“Š í†µê³„ ì‹¤í—˜ì‹¤ (Single)
                <span class="block text-xs font-normal opacity-80">ëŒ€ìˆ˜ì˜ ë²•ì¹™ ê²€ì¦ ë° ë°ì´í„° ìˆ˜ì§‘</span>
            </button>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="setupMultiplayer('host')" class="py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg transition">
                    ë°© ë§Œë“¤ê¸° (Host)
                </button>
                <button onclick="setupMultiplayer('guest')" class="py-4 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl text-lg transition">
                    ì°¸ê°€í•˜ê¸° (Guest)
                </button>
            </div>
        </div>
    </div>

    <div id="screen-single" class="hidden-screen w-full max-w-6xl h-[800px] flex gap-4 p-4">
        <div class="w-1/3 bg-gray-800 p-6 rounded-2xl border border-gray-700 flex flex-col">
            <h2 class="text-2xl font-bold text-white mb-4">ğŸ§ª ì‹¤í—˜ ì œì–´íŒ</h2>
            <div class="space-y-4">
                <button onclick="singleRoll()" class="w-full py-3 bg-blue-600 text-white font-bold rounded">1íšŒ ì‹œí–‰ (Roll)</button>
                <button onclick="singleAutoRoll(100)" class="w-full py-3 bg-indigo-600 text-white font-bold rounded">100íšŒ ìë™ ì‹œí–‰</button>
                <button onclick="resetStats()" class="w-full py-3 bg-red-900 text-red-200 font-bold rounded">ë°ì´í„° ì´ˆê¸°í™”</button>
                <div class="bg-gray-900 p-4 rounded mt-4">
                    <p class="text-gray-400 text-sm">ì´ ì‹œí–‰ íšŸìˆ˜ (n)</p>
                    <div class="text-3xl font-bold text-white" id="single-total">0</div>
                </div>
            </div>
            <button onclick="location.reload()" class="mt-auto py-2 text-gray-500 hover:text-white">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <div class="w-2/3 bg-gray-900 p-6 rounded-2xl border border-gray-700 flex flex-col">
            <h3 class="text-xl font-bold text-gray-300 mb-4">ğŸ“ˆ í™•ë¥  ë¶„í¬ ê·¸ë˜í”„</h3>
            <div class="flex-1 bg-gray-800 rounded-xl p-4 relative">
                <canvas id="statChart"></canvas>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">ì´ë¡ ì  í™•ë¥ (16.6%) vs ì‹¤í—˜ì  í™•ë¥  ë¹„êµ</p>
        </div>
    </div>

    <div id="screen-lobby" class="hidden-screen w-full max-w-md p-8 bg-gray-800 rounded-2xl border border-gray-700 text-center">
        <h2 class="text-2xl font-bold text-white mb-4" id="lobby-title">ëŒ€ê¸°ì‹¤</h2>
        
        <div id="host-info" class="hidden-screen mb-6">
            <p class="text-sm text-gray-400">ì´ˆëŒ€ ì½”ë“œ (ID)</p>
            <div class="flex items-center justify-center gap-2 bg-gray-900 p-2 rounded mb-2">
                <span id="my-peer-id" class="text-xl font-bold text-yellow-400 select-all">...</span>
                <button onclick="copyId()" class="text-xs bg-gray-700 px-2 py-1 rounded">ë³µì‚¬</button>
            </div>
            <p class="text-xs text-gray-500">ì¹œêµ¬ë“¤ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</p>
        </div>

        <div id="guest-input" class="hidden-screen mb-6">
            <input type="text" id="host-id-input" placeholder="ë°©ì¥ ID ì…ë ¥" class="w-full p-3 bg-gray-700 rounded text-center text-white mb-2">
            <button onclick="joinRoom()" class="w-full py-2 bg-purple-600 font-bold rounded">ì—°ê²°í•˜ê¸°</button>
        </div>

        <div class="bg-gray-700 p-4 rounded-xl mb-6 text-left">
            <p class="text-xs text-gray-400 mb-2">ì°¸ê°€ì ëª©ë¡ (<span id="player-count">1</span>/4)</p>
            <ul id="player-list" class="space-y-1 text-sm font-bold text-white">
                </ul>
        </div>

        <div id="host-controls" class="hidden-screen space-y-2">
            <div class="flex justify-center gap-2 mb-4">
                <button onclick="setRounds(3)" class="round-btn bg-blue-600 px-3 py-1 rounded text-xs text-white">3R</button>
                <button onclick="setRounds(5)" class="round-btn bg-gray-600 px-3 py-1 rounded text-xs text-white">5R</button>
                <button onclick="setRounds(10)" class="round-btn bg-gray-600 px-3 py-1 rounded text-xs text-white">10R</button>
            </div>
            <button onclick="broadcastStart()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl">ê²Œì„ ì‹œì‘</button>
        </div>
        <div id="guest-waiting" class="hidden-screen text-yellow-400 animate-pulse font-bold">
            ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
        </div>
    </div>

    <div id="screen-multi-game" class="hidden-screen w-full max-w-6xl p-4 flex gap-4 h-[700px]">
        
        <div class="w-2/3 bg-gray-800 rounded-2xl border-2 border-gray-700 p-6 flex flex-col relative">
            <div class="flex justify-between items-center mb-10">
                <div class="text-xs text-gray-400">ROUND <span id="multi-round">1</span></div>
                <div id="turn-msg" class="text-xl font-bold text-white bg-gray-700 px-4 py-1 rounded-full">ê²Œì„ ëŒ€ê¸°ì¤‘</div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
                <div class="flex gap-4 mb-8" id="my-dice-container">
                    <div class="die die-lg" onclick="toggleLock(0)">1</div>
                    <div class="die die-lg" onclick="toggleLock(1)">2</div>
                    <div class="die die-lg" onclick="toggleLock(2)">3</div>
                    <div class="die die-lg" onclick="toggleLock(3)">4</div>
                    <div class="die die-lg" onclick="toggleLock(4)">5</div>
                </div>
                <div class="text-4xl font-bold text-yellow-400 h-10" id="my-hand-rank">-</div>
            </div>

            <div id="my-controls" class="mt-auto opacity-50 pointer-events-none transition">
                <div class="mb-4">
                    <p class="text-xs text-gray-400 mb-1">íˆ¬ìê¸ˆ ì„¤ì •: $<span id="my-bet-display">0</span></p>
                    <input type="range" id="my-bet-slider" class="w-full accent-green-500 h-2 bg-gray-600 rounded-lg cursor-pointer" min="0" max="1000">
                </div>
                <div class="flex gap-4">
                    <button onclick="multiRoll()" class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-xl">ROLL (<span id="my-rolls">3</span>)</button>
                    <button onclick="multiKeep()" class="flex-1 py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-xl">KEEP</button>
                </div>
            </div>
        </div>

        <div class="w-1/3 bg-gray-900 rounded-2xl p-4 border border-gray-700 flex flex-col">
            <h3 class="text-sm font-bold text-gray-400 mb-4">PLAYERS</h3>
            <div id="players-status" class="space-y-3 flex-1 overflow-y-auto">
                </div>
            
            <div class="mt-4 bg-black/50 p-3 rounded text-[10px] text-gray-500 h-32 overflow-y-auto font-mono" id="multi-log">
                > ì ‘ì† ì™„ë£Œ
            </div>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center hidden-screen">
        <h1 class="text-6xl font-title text-yellow-400 mb-8">GAME OVER</h1>
        <div id="rankings" class="w-full max-w-md space-y-4 mb-8">
            </div>
        <button onclick="location.reload()" class="px-8 py-3 bg-white text-black font-bold rounded-full">ë¡œë¹„ë¡œ ë‚˜ê°€ê¸°</button>
    </div>

    <script>
        // ==========================================
        // 1. ê³µí†µ ë°ì´í„° ë° ìœ í‹¸
        // ==========================================
        const HANDS = [
            { name: "Yacht", mult: 10, check: d=>hasKind(d,5) },
            { name: "4 Kind", mult: 5, check: d=>hasKind(d,4) },
            { name: "Full House", mult: 3, check: d=>isFullHouse(d) },
            { name: "Straight", mult: 2, check: d=>isStraight(d) },
            { name: "3 Kind", mult: 1.5, check: d=>hasKind(d,3) },
            { name: "2 Pair", mult: 1.0, check: d=>isTwoPair(d) },
            { name: "1 Pair", mult: 0.5, check: d=>hasKind(d,2) },
            { name: "No Pair", mult: 0, check: d=>true }
        ];
        function evaluate(d) { return HANDS.find(h => h.check(d)); }
        function hasKind(d,n){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);return Object.values(c).some(v=>v>=n);}
        function isFullHouse(d){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);const v=Object.values(c);return (v.includes(3)&&v.includes(2))||v.includes(5);}
        function isStraight(d){const u=[...new Set(d)].sort().join('');return u.includes('1234')||u.includes('2345')||u.includes('3456');} // Small Straight ê¸°ì¤€
        function isTwoPair(d){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);return Object.values(c).filter(v=>v>=2).length>=2;}

        // ==========================================
        // 2. ëª¨ë“œ 1: ì‹±ê¸€ (í†µê³„ ì‹¤í—˜)
        // ==========================================
        let singleStats = [0,0,0,0,0,0];
        let singleTotal = 0;
        let myChart = null;

        function startSinglePlayer() {
            document.getElementById('screen-menu').classList.add('hidden-screen');
            document.getElementById('screen-single').classList.remove('hidden-screen');
            initChart();
        }

        function singleRoll() {
            const val = Math.floor(Math.random()*6);
            singleStats[val]++;
            singleTotal++;
            updateChart();
        }

        function singleAutoRoll(n) {
            for(let i=0; i<n; i++) singleRoll();
        }

        function resetStats() {
            singleStats = [0,0,0,0,0,0];
            singleTotal = 0;
            updateChart();
        }

        function initChart() {
            const ctx = document.getElementById('statChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1', '2', '3', '4', '5', '6'],
                    datasets: [{
                        label: 'ì‹¤í—˜ì  í™•ë¥  (%)',
                        data: [0,0,0,0,0,0],
                        backgroundColor: '#3b82f6'
                    }, {
                        type: 'line',
                        label: 'ì´ë¡ ì  í™•ë¥  (16.6%)',
                        data: [16.6, 16.6, 16.6, 16.6, 16.6, 16.6],
                        borderColor: '#fbbf24',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 50 } },
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });
        }

        function updateChart() {
            document.getElementById('single-total').innerText = singleTotal;
            if(singleTotal === 0) return;
            const percentages = singleStats.map(v => (v/singleTotal*100).toFixed(1));
            myChart.data.datasets[0].data = percentages;
            myChart.update();
        }


        // ==========================================
        // 3. ëª¨ë“œ 2: ë©€í‹°í”Œë ˆì´ (P2P Host-Guest)
        // ==========================================
        let peer = null;
        let connections = []; // Hostìš©: ì—°ê²°ëœ Peerë“¤
        let hostConn = null;  // Guestìš©: Hostì™€ì˜ ì—°ê²°
        let myId = null;
        let isHost = false;
        
        let GAME = {
            players: [], // { id, name, money, dice, rolls, hand, isTurn }
            round: 1,
            maxRounds: 3,
            currentTurnIndex: 0,
            state: 'lobby' // lobby, playing, finished
        };

        function setupMultiplayer(role) {
            document.getElementById('screen-menu').classList.add('hidden-screen');
            document.getElementById('screen-lobby').classList.remove('hidden-screen');
            
            peer = new Peer(); // ID ìë™ ìƒì„±
            
            peer.on('open', id => {
                myId = id;
                document.getElementById('my-peer-id').innerText = id;
                
                if (role === 'host') {
                    isHost = true;
                    document.getElementById('host-info').classList.remove('hidden-screen');
                    document.getElementById('host-controls').classList.remove('hidden-screen');
                    // ë‚˜ ìì‹ ì„ í”Œë ˆì´ì–´ ëª©ë¡ì— ì¶”ê°€
                    GAME.players.push({ id: myId, name: "HOST (ë‚˜)", money: 1000, dice:[1,1,1,1,1], rolls:3, bet:0 });
                    updateLobbyUI();
                } else {
                    document.getElementById('guest-input').classList.remove('hidden-screen');
                    document.getElementById('guest-waiting').classList.remove('hidden-screen');
                }
            });

            peer.on('connection', conn => {
                if (isHost) {
                    // Host: ì ‘ì†ì ì²˜ë¦¬
                    connections.push(conn);
                    setupDataHandler(conn);
                    
                    // ìƒˆ í”Œë ˆì´ì–´ ë“±ë¡
                    const newPlayer = { id: conn.peer, name: `Player ${GAME.players.length + 1}`, money: 1000, dice:[1,1,1,1,1], rolls:3, bet:0 };
                    GAME.players.push(newPlayer);
                    
                    // ì „ì²´ ë¸Œë¡œë“œìºìŠ¤íŠ¸ (ë¡œë¹„ ê°±ì‹ )
                    broadcast({ type: 'LOBBY_UPDATE', players: GAME.players });
                    updateLobbyUI();
                } else {
                    // Guest: Host ì ‘ì† ì‹œ (ë³´í†µ ë°˜ëŒ€ ë°©í–¥ì´ë¼ ì—¬ê¸° ì•ˆì˜´, í˜¹ì‹œë‚˜ ì–‘ë°©í–¥ì´ë©´ ì‚¬ìš©)
                }
            });
        }

        function joinRoom() {
            const hostId = document.getElementById('host-id-input').value;
            if (!hostId) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            
            hostConn = peer.connect(hostId);
            hostConn.on('open', () => {
                document.getElementById('guest-input').classList.add('hidden-screen'); // ì—°ê²°ë˜ë©´ ì…ë ¥ì°½ ìˆ¨ê¹€
                setupDataHandler(hostConn);
            });
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            alert("ID ë³µì‚¬ë¨!");
        }

        // --- ë°ì´í„° ì²˜ë¦¬ (í†µì‹ ) ---
        function setupDataHandler(conn) {
            conn.on('data', data => {
                // console.log("Received:", data);
                
                if (data.type === 'LOBBY_UPDATE') {
                    GAME.players = data.players;
                    updateLobbyUI();
                }
                else if (data.type === 'GAME_START') {
                    GAME = data.gameState;
                    initGameUI();
                }
                else if (data.type === 'STATE_UPDATE') {
                    GAME = data.gameState;
                    updateGameUI();
                }
                else if (data.type === 'GAME_OVER') {
                    showResult(data.rankings);
                }
                // Host ì „ìš©: í´ë¼ì´ì–¸íŠ¸ í–‰ë™ ìˆ˜ì‹ 
                else if (isHost && data.type === 'ACTION') {
                    handlePlayerAction(data.senderId, data.action, data.payload);
                }
            });
        }

        function broadcast(msg) {
            if (isHost) {
                connections.forEach(c => c.send(msg));
            }
        }

        function sendToHost(type, payload) {
            if (isHost) {
                // ë‚´ê°€ Hostë©´ ì§ì ‘ ì²˜ë¦¬
                handlePlayerAction(myId, type, payload);
            } else {
                hostConn.send({ type: 'ACTION', senderId: myId, action: type, payload: payload });
            }
        }

        // --- ë¡œë¹„ UI ---
        function updateLobbyUI() {
            const list = document.getElementById('player-list');
            list.innerHTML = GAME.players.map(p => 
                `<li class="${p.id === myId ? 'text-yellow-400' : ''}">${p.name} ${p.id===myId?'(ë‚˜)':''}</li>`
            ).join('');
            document.getElementById('player-count').innerText = GAME.players.length;
        }

        function setRounds(n) {
            GAME.maxRounds = n;
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°±ì‹ 
            document.querySelectorAll('.round-btn').forEach(b => b.classList.remove('bg-blue-600'));
            event.target.classList.add('bg-blue-600');
        }

        function broadcastStart() {
            GAME.state = 'playing';
            GAME.currentTurnIndex = 0;
            // ì´ˆê¸°í™”
            GAME.players.forEach(p => {
                p.dice = [1,2,3,4,5];
                p.rolls = 3;
                p.bet = 0;
            });
            
            const msg = { type: 'GAME_START', gameState: GAME };
            broadcast(msg); // Guestë“¤ì—ê²Œ ì „ì†¡
            initGameUI();   // ë‚˜(Host)ë„ ì‹œì‘
        }

        // --- ê²Œì„ UI ë° ë¡œì§ ---
        function initGameUI() {
            document.getElementById('screen-lobby').classList.add('hidden-screen');
            document.getElementById('screen-multi-game').classList.remove('hidden-screen');
            updateGameUI();
        }

        function updateGameUI() {
            document.getElementById('multi-round').innerText = `${GAME.round}/${GAME.maxRounds}`;
            
            const currentPlayer = GAME.players[GAME.currentTurnIndex];
            const isMyTurn = currentPlayer.id === myId;
            
            // 1. í„´ ë©”ì‹œì§€
            const turnMsg = document.getElementById('turn-msg');
            if (isMyTurn) {
                turnMsg.innerText = "â­ ë‚˜ì˜ í„´!";
                turnMsg.className = "text-xl font-bold text-black bg-yellow-400 px-4 py-1 rounded-full animate-bounce";
                document.getElementById('my-controls').classList.remove('opacity-50', 'pointer-events-none');
            } else {
                turnMsg.innerText = `${currentPlayer.name}ì˜ í„´...`;
                turnMsg.className = "text-xl font-bold text-white bg-gray-700 px-4 py-1 rounded-full";
                document.getElementById('my-controls').classList.add('opacity-50', 'pointer-events-none');
            }

            // 2. ë‚´ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë‚´ ë°ì´í„°ëŠ” players ë°°ì—´ì—ì„œ ë‚´ idë¡œ ì°¾ìŒ)
            const me = GAME.players.find(p => p.id === myId);
            
            // ì£¼ì‚¬ìœ„ ë Œë”ë§ (ë§Œì•½ ë‚´ í„´ì´ë©´ ë‚´ í™”ë©´ì˜ ì£¼ì‚¬ìœ„, ì•„ë‹ˆë©´ ì„œë²„ ë°ì´í„°)
            // í¸ì˜ìƒ í•­ìƒ ì„œë²„(GAME) ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ë Œë”ë§
            const myDiceContainer = document.getElementById('my-dice-container');
            myDiceContainer.innerHTML = me.dice.map((v, i) => `
                <div class="die die-lg ${isMyTurn && myLocked[i] ? 'locked' : ''}" onclick="toggleLock(${i})">${v}</div>
            `).join('');
            
            // ì¡±ë³´ ê³„ì‚° ë° í‘œì‹œ
            const res = evaluate(me.dice);
            document.getElementById('my-hand-rank').innerText = `${res.name} (x${res.mult})`;
            document.getElementById('my-rolls').innerText = me.rolls;
            
            // ë² íŒ…ë°” (ë‚´ í„´ì¼ë•Œë§Œ ê°’ ë³€ê²½ ê°€ëŠ¥í•˜ê²ŒëŠ” HTML input ì†ì„±ìœ¼ë¡œ ì œì–´ ê°€ëŠ¥í•˜ì§€ë§Œ ì—¬ê¸°ì„  ìŠ¬ë¼ì´ë” UI ê°±ì‹ ë§Œ)
            if(!isMyTurn) {
                document.getElementById('my-bet-display').innerText = me.bet;
                document.getElementById('my-bet-slider').value = me.bet;
            }

            // 3. ì˜¤ë¥¸ìª½ í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ (í˜„í™©íŒ)
            const pList = document.getElementById('players-status');
            pList.innerHTML = GAME.players.map(p => `
                <div class="player-card ${p.id === GAME.players[GAME.currentTurnIndex].id ? 'active-turn' : ''} ${p.id===myId?'is-me':''}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-white">${p.name}</span>
                        <span class="text-yellow-400 font-bold">$${p.money.toLocaleString()}</span>
                    </div>
                    <div class="flex gap-1 justify-center mb-1">
                        ${p.dice.map(d => `<div class="w-6 h-6 bg-gray-200 rounded text-black text-center text-xs leading-6 font-bold">${d}</div>`).join('')}
                    </div>
                    <div class="text-[10px] text-gray-400 text-center">
                        íˆ¬ì: $${p.bet} | ë‚¨ì€ ë¡¤: ${p.rolls}
                    </div>
                </div>
            `).join('');
        }

        // --- í´ë¼ì´ì–¸íŠ¸ ì•¡ì…˜ (ë‚˜ì˜ í–‰ë™) ---
        let myLocked = [false,false,false,false,false];

        function toggleLock(idx) {
            const currentPlayer = GAME.players[GAME.currentTurnIndex];
            if (currentPlayer.id !== myId || currentPlayer.rolls === 3) return; // ë‚´ í„´ ì•„ë‹ˆê±°ë‚˜ ì²« ë¡¤ ì „
            myLocked[idx] = !myLocked[idx];
            updateGameUI(); // í™”ë©´ ê°±ì‹  (locked í´ë˜ìŠ¤ ì ìš© ìœ„í•´)
        }

        // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        document.getElementById('my-bet-slider').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            const me = GAME.players.find(p => p.id === myId);
            if(val > me.money) e.target.value = me.money; // ê°€ì§„ ëˆ ì´ˆê³¼ ë°©ì§€
            document.getElementById('my-bet-display').innerText = e.target.value;
        });

        function multiRoll() {
            const me = GAME.players.find(p => p.id === myId);
            if(me.rolls <= 0) return;
            
            const betVal = parseInt(document.getElementById('my-bet-slider').value);
            if(betVal <= 0) return alert("íˆ¬ìë¥¼ í•˜ì„¸ìš”!");

            // í˜¸ìŠ¤íŠ¸ì—ê²Œ ë¡¤ ìš”ì²­
            sendToHost('ROLL', { locked: myLocked, bet: betVal });
        }

        function multiKeep() {
            const betVal = parseInt(document.getElementById('my-bet-slider').value);
            sendToHost('KEEP', { bet: betVal });
        }

        function addLog(msg) {
            const log = document.getElementById('multi-log');
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            log.prepend(d);
        }

        // --- Host ì „ìš© ë¡œì§ (ê²Œì„ ìƒíƒœ ê´€ë¦¬) ---
        function handlePlayerAction(senderId, action, payload) {
            // í˜„ì¬ í„´ í”Œë ˆì´ì–´ì¸ì§€ ê²€ì¦
            const pIdx = GAME.players.findIndex(p => p.id === senderId);
            if (pIdx !== GAME.currentTurnIndex) return; // í„´ ì•„ë‹˜ ë¬´ì‹œ

            const player = GAME.players[pIdx];

            if (action === 'ROLL') {
                if (player.rolls > 0) {
                    player.bet = payload.bet; // ë² íŒ… í™•ì •
                    player.rolls--;
                    // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° (ì„œë²„(Host)ì—ì„œ ëœë¤ ìƒì„± - ê³µì •ì„±)
                    player.dice = player.dice.map((v, i) => payload.locked[i] ? v : Math.floor(Math.random()*6)+1);
                    
                    broadcast({ type: 'STATE_UPDATE', gameState: GAME });
                }
            }
            else if (action === 'KEEP') {
                // ì ìˆ˜ ê³„ì‚° ë° í„´ ë„˜ê¸°ê¸°
                const hand = evaluate(player.dice);
                const profit = Math.floor(player.bet * hand.mult);
                // ê¸°ì¡´ ìì‚°ì—ì„œ ë² íŒ…ê¸ˆì„ ë¹¼ê³  ìˆ˜ìµì„ ë”í•¨ (ìˆ˜ìµì´ 0ì´ë©´ ë² íŒ…ê¸ˆ ë‚ ë¦¼)
                // ë¡œì§: money = money - bet + profit
                player.money = player.money - player.bet + profit;
                
                // í„´ ë„˜ê¸°ê¸°
                player.rolls = 3; 
                player.bet = 0;
                // player.dice = [1,1,1,1,1]; // ë‹¤ìŒ ì‚¬ëŒì„ ìœ„í•´ ì´ˆê¸°í™”? ì•„ë‹ˆë©´ ê²°ê³¼ ìœ ì§€? ìœ ì§€í•˜ëŠ”ê²Œ ì¢‹ìŒ.
                
                GAME.currentTurnIndex++;
                if (GAME.currentTurnIndex >= GAME.players.length) {
                    // ë¼ìš´ë“œ ì¢…ë£Œ
                    GAME.currentTurnIndex = 0;
                    GAME.round++;
                    if (GAME.round > GAME.maxRounds) {
                        // ê²Œì„ ì˜¤ë²„
                        const rankings = [...GAME.players].sort((a,b) => b.money - a.money);
                        broadcast({ type: 'GAME_OVER', rankings: rankings });
                        showResult(rankings); // Host ë³¸ì¸ë„ ì‹¤í–‰
                        return;
                    }
                }
                
                // ë‹¤ìŒ í„´ ì£¼ìì˜ ì£¼ì‚¬ìœ„ ë“± ì´ˆê¸°í™” (í•„ìš”ì‹œ)
                const nextPlayer = GAME.players[GAME.currentTurnIndex];
                nextPlayer.rolls = 3; 
                nextPlayer.bet = 0;
                
                broadcast({ type: 'STATE_UPDATE', gameState: GAME });
            }
        }

        // --- ê²°ê³¼ í™”ë©´ ---
        function showResult(rankings) {
            document.getElementById('screen-multi-game').classList.add('hidden-screen');
            document.getElementById('result-modal').classList.remove('hidden-screen');
            
            const div = document.getElementById('rankings');
            div.innerHTML = rankings.map((p, i) => `
                <div class="flex justify-between items-center bg-gray-800 p-4 rounded-xl border ${p.id===myId?'border-blue-500':'border-gray-600'}">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl font-black ${i===0?'text-yellow-400':'text-gray-500'}">#${i+1}</span>
                        <span class="text-white font-bold text-xl">${p.name}</span>
                    </div>
                    <span class="text-2xl text-green-400 font-bold">$${p.money.toLocaleString()}</span>
                </div>
            `).join('');
        }

    </script>
</body>
</html>
