<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² Dice Vestor: Final Edition</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Roboto Mono', monospace; user-select: none; }
        .font-title { font-family: 'Black Han Sans', sans-serif; }
        .hidden-screen { display: none !important; }
        
        /* ì£¼ì‚¬ìœ„ */
        .die {
            width: 50px; height: 50px;
            background: linear-gradient(145deg, #ffffff, #e2e8f0); color: #1e293b;
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold; box-shadow: 0 4px 0 #94a3b8;
            cursor: pointer; transition: transform 0.1s;
        }
        .die.locked { background: #ef4444; color: white; box-shadow: 0 4px 0 #991b1b; transform: translateY(4px); }
        .die-lg { width: 70px; height: 70px; font-size: 2rem; }
        .rolling { animation: shake 0.4s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }

        /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 50;
            background: rgba(0,0,0,0.5); color: white; padding: 8px 16px; border-radius: 8px;
            font-size: 0.8rem; cursor: pointer; transition: background 0.2s; border: 1px solid #444;
        }
        .back-btn:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body class="h-screen flex items-center justify-center overflow-hidden relative">

    <button id="global-back-btn" class="back-btn hidden-screen" onclick="goToMain()">
        &lt; ë©”ì¸ìœ¼ë¡œ
    </button>

    <div id="screen-menu" class="w-full max-w-md p-8 bg-gray-800 rounded-2xl border border-gray-700 shadow-2xl text-center">
        <h1 class="text-5xl font-title text-yellow-400 mb-2">ğŸ² DICE VESTOR</h1>
        <p class="text-gray-400 mb-8 text-sm">í™•ë¥  í†µê³„ ì‹¤í—˜ & íˆ¬ì ë°°í‹€</p>
        
        <div class="space-y-4">
            <button onclick="startSinglePlayer()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-lg transition flex flex-col items-center">
                <span>ğŸ‘¤ ê°œì¸ í”Œë ˆì´</span>
                <span class="text-[10px] opacity-70 font-normal">í†µê³„ ì‹¤í—˜ì‹¤ (ì´ë¡  vs ì‹¤ì œ)</span>
            </button>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="setupMultiplayer('host')" class="py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-lg transition flex flex-col items-center">
                    <span>ğŸ  ë°© ë§Œë“¤ê¸°</span>
                    <span class="text-[10px] opacity-70 font-normal">Host</span>
                </button>
                <button onclick="setupMultiplayer('guest')" class="py-4 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl text-lg transition flex flex-col items-center">
                    <span>ğŸ”— ì°¸ê°€í•˜ê¸°</span>
                    <span class="text-[10px] opacity-70 font-normal">Guest</span>
                </button>
            </div>
        </div>
    </div>

    <div id="screen-single" class="hidden-screen w-full max-w-6xl h-[800px] flex gap-4 p-4 pt-16">
        <div class="w-1/3 bg-gray-800 p-6 rounded-2xl border border-gray-700 flex flex-col">
            <h2 class="text-2xl font-bold text-white mb-4">ğŸ§ª ì‹¤í—˜ ì œì–´íŒ</h2>
            <div class="space-y-4">
                <button onclick="singleRoll()" class="w-full py-3 bg-blue-600 text-white font-bold rounded hover:bg-blue-500">1íšŒ ì‹œí–‰ (Roll)</button>
                <button onclick="singleAutoRoll(100)" class="w-full py-3 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-500">100íšŒ ìë™ ì‹œí–‰</button>
                <button onclick="resetStats()" class="w-full py-3 bg-red-900 text-red-200 font-bold rounded hover:bg-red-800">ë°ì´í„° ì´ˆê¸°í™”</button>
                <div class="bg-gray-900 p-4 rounded mt-4 text-center">
                    <p class="text-gray-400 text-xs mb-1">ì´ ì‹œí–‰ íšŸìˆ˜ (n)</p>
                    <div class="text-4xl font-bold text-white" id="single-total">0</div>
                </div>
            </div>
        </div>
        <div class="w-2/3 bg-gray-900 p-6 rounded-2xl border border-gray-700 flex flex-col">
            <h3 class="text-xl font-bold text-gray-300 mb-4">ğŸ“ˆ ëŒ€ìˆ˜ì˜ ë²•ì¹™ ê²€ì¦</h3>
            <div class="flex-1 bg-gray-800 rounded-xl p-4 relative">
                <canvas id="statChart"></canvas>
            </div>
            <p class="text-center text-xs text-gray-500 mt-2">ì´ë¡ ì  í™•ë¥ (ì ì„ )ì— ìˆ˜ë ´í•˜ëŠ” ê³¼ì •ì„ ê´€ì°°í•˜ì„¸ìš”.</p>
        </div>
    </div>

    <div id="screen-lobby" class="hidden-screen w-full max-w-md p-8 bg-gray-800 rounded-2xl border border-gray-700 text-center mt-10">
        <h2 class="text-2xl font-bold text-white mb-4" id="lobby-title">ëŒ€ê¸°ì‹¤</h2>
        
        <div id="host-info" class="hidden-screen mb-6">
            <p class="text-sm text-gray-400">ì´ˆëŒ€ ì½”ë“œ (ID)</p>
            <div class="flex items-center justify-center gap-2 bg-gray-900 p-2 rounded mb-2">
                <span id="my-peer-id" class="text-xl font-bold text-yellow-400 select-all">Loading...</span>
                <button onclick="copyId()" class="text-xs bg-gray-700 px-2 py-1 rounded hover:bg-gray-600">ë³µì‚¬</button>
            </div>
            <p class="text-xs text-gray-500">ì¹œêµ¬ì—ê²Œ ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”.</p>
        </div>

        <div id="guest-input" class="hidden-screen mb-6">
            <input type="text" id="host-id-input" placeholder="ë°©ì¥ ID ì…ë ¥" class="w-full p-3 bg-gray-700 rounded text-center text-white mb-2 focus:ring-2 focus:ring-purple-500 outline-none">
            <button onclick="joinRoom()" class="w-full py-2 bg-purple-600 font-bold rounded hover:bg-purple-500">ì—°ê²°í•˜ê¸°</button>
        </div>

        <div class="bg-gray-700 p-4 rounded-xl mb-6 text-left">
            <p class="text-xs text-gray-400 mb-2">ì°¸ê°€ì (<span id="player-count">1</span>ëª…)</p>
            <ul id="player-list" class="space-y-1 text-sm font-bold text-white"></ul>
        </div>

        <div id="host-controls" class="hidden-screen space-y-2">
            <div class="flex justify-center gap-2 mb-4">
                <button onclick="setRounds(3)" class="round-btn bg-blue-600 px-3 py-1 rounded text-xs text-white">3R</button>
                <button onclick="setRounds(5)" class="round-btn bg-gray-600 px-3 py-1 rounded text-xs text-white">5R</button>
                <button onclick="setRounds(10)" class="round-btn bg-gray-600 px-3 py-1 rounded text-xs text-white">10R</button>
            </div>
            <button onclick="broadcastStart()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl">ê²Œì„ ì‹œì‘</button>
        </div>
        <div id="guest-waiting" class="hidden-screen text-yellow-400 animate-pulse font-bold text-sm">
            ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
        </div>
    </div>

    <div id="screen-multi-game" class="hidden-screen w-full max-w-6xl p-4 flex gap-4 h-[700px] pt-16">
        
        <div class="w-2/3 bg-gray-800 rounded-2xl border-2 border-gray-700 p-6 flex flex-col relative">
            <div class="flex justify-between items-center mb-8">
                <div class="text-xs text-gray-400">ROUND <span id="multi-round">1</span></div>
                <div id="turn-msg" class="text-lg font-bold text-white bg-gray-700 px-4 py-1 rounded-full">ëŒ€ê¸°ì¤‘</div>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
                <div class="flex gap-4 mb-6" id="my-dice-container">
                    <div class="die die-lg" onclick="toggleLock(0)">1</div>
                    <div class="die die-lg" onclick="toggleLock(1)">2</div>
                    <div class="die die-lg" onclick="toggleLock(2)">3</div>
                    <div class="die die-lg" onclick="toggleLock(3)">4</div>
                    <div class="die die-lg" onclick="toggleLock(4)">5</div>
                </div>
                <div class="text-3xl font-bold text-yellow-400 h-10" id="my-hand-rank">-</div>
            </div>

            <div id="my-controls" class="mt-auto opacity-50 pointer-events-none transition">
                <div class="mb-4">
                    <p class="text-xs text-gray-400 mb-1">íˆ¬ìê¸ˆ: $<span id="my-bet-display">0</span></p>
                    <input type="range" id="my-bet-slider" class="w-full accent-green-500 h-2 bg-gray-600 rounded-lg cursor-pointer" min="0" max="1000">
                </div>
                <div class="flex gap-4">
                    <button onclick="multiRoll()" class="flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-xl">ROLL (<span id="my-rolls">3</span>)</button>
                    <button onclick="multiKeep()" class="flex-1 py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-xl">KEEP</button>
                </div>
            </div>
        </div>

        <div class="w-1/3 bg-gray-900 rounded-2xl p-4 border border-gray-700 flex flex-col">
            <h3 class="text-sm font-bold text-gray-400 mb-4">PLAYERS STATUS</h3>
            <div id="players-status" class="space-y-3 flex-1 overflow-y-auto"></div>
            <div class="mt-4 bg-black/50 p-3 rounded text-[10px] text-gray-500 h-24 overflow-y-auto font-mono" id="multi-log">> ì ‘ì† ì™„ë£Œ</div>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center hidden-screen">
        <h1 class="text-6xl font-title text-yellow-400 mb-8">GAME OVER</h1>
        <div id="rankings" class="w-full max-w-md space-y-4 mb-8"></div>
        <button onclick="goToMain()" class="px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105">ë©”ì¸ìœ¼ë¡œ ë‚˜ê°€ê¸°</button>
    </div>

    <script>
        // ==========================================
        // 0. í™”ë©´ ì „í™˜ ê´€ë¦¬ (Navigation)
        // ==========================================
        function showScreen(id) {
            // ëª¨ë“  ìŠ¤í¬ë¦° ìˆ¨ê¹€
            ['screen-menu', 'screen-single', 'screen-lobby', 'screen-multi-game', 'result-modal'].forEach(s => {
                document.getElementById(s).classList.add('hidden-screen');
            });
            // ëŒ€ìƒ ìŠ¤í¬ë¦° í‘œì‹œ
            document.getElementById(id).classList.remove('hidden-screen');

            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ (ë©”ì¸ í™”ë©´ì—ì„œëŠ” ìˆ¨ê¹€)
            const backBtn = document.getElementById('global-back-btn');
            if (id === 'screen-menu') backBtn.classList.add('hidden-screen');
            else backBtn.classList.remove('hidden-screen');
        }

        function goToMain() {
            // ì—°ê²° ì¢…ë£Œ ë° ì´ˆê¸°í™”
            if (peer) { peer.destroy(); peer = null; }
            connections = [];
            hostConn = null;
            isHost = false;
            
            // ì‹±ê¸€ ë°ì´í„° ì´ˆê¸°í™”ëŠ” ì„ íƒì‚¬í•­ (ì—¬ê¸°ì„  ìœ ì§€)
            
            showScreen('screen-menu');
        }

        // ==========================================
        // 1. ê³µí†µ ë°ì´í„°
        // ==========================================
        const HANDS = [
            { name: "Yacht", mult: 10, check: d=>hasKind(d,5) },
            { name: "4 Kind", mult: 5, check: d=>hasKind(d,4) },
            { name: "Full House", mult: 3, check: d=>isFullHouse(d) },
            { name: "Straight", mult: 2, check: d=>isStraight(d) },
            { name: "3 Kind", mult: 1.5, check: d=>hasKind(d,3) },
            { name: "2 Pair", mult: 1.0, check: d=>isTwoPair(d) },
            { name: "1 Pair", mult: 0.5, check: d=>hasKind(d,2) },
            { name: "No Pair", mult: 0, check: d=>true }
        ];
        function evaluate(d) { return HANDS.find(h => h.check(d)); }
        function hasKind(d,n){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);return Object.values(c).some(v=>v>=n);}
        function isFullHouse(d){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);const v=Object.values(c);return (v.includes(3)&&v.includes(2))||v.includes(5);}
        function isStraight(d){const u=[...new Set(d)].sort().join('');return u.includes('1234')||u.includes('2345')||u.includes('3456');}
        function isTwoPair(d){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);return Object.values(c).filter(v=>v>=2).length>=2;}

        // ==========================================
        // 2. ëª¨ë“œ 1: ê°œì¸ í”Œë ˆì´ (í†µê³„)
        // ==========================================
        let singleStats = [0,0,0,0,0,0];
        let singleTotal = 0;
        let myChart = null;

        function startSinglePlayer() {
            showScreen('screen-single');
            if(!myChart) initChart();
        }

        function singleRoll() {
            const val = Math.floor(Math.random()*6);
            singleStats[val]++;
            singleTotal++;
            updateChart();
        }

        function singleAutoRoll(n) {
            for(let i=0; i<n; i++) singleRoll();
        }

        function resetStats() {
            singleStats = [0,0,0,0,0,0];
            singleTotal = 0;
            updateChart();
        }

        function initChart() {
            const ctx = document.getElementById('statChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1', '2', '3', '4', '5', '6'],
                    datasets: [{
                        label: 'ì‹¤í—˜ì  í™•ë¥  (%)',
                        data: [0,0,0,0,0,0],
                        backgroundColor: '#3b82f6'
                    }, {
                        type: 'line',
                        label: 'ì´ë¡ ì  í™•ë¥  (16.6%)',
                        data: [16.6, 16.6, 16.6, 16.6, 16.6, 16.6],
                        borderColor: '#fbbf24',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 40 } },
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });
        }

        function updateChart() {
            document.getElementById('single-total').innerText = singleTotal;
            if(singleTotal === 0) return;
            const percentages = singleStats.map(v => (v/singleTotal*100).toFixed(1));
            myChart.data.datasets[0].data = percentages;
            myChart.update();
        }

        // ==========================================
        // 3. ëª¨ë“œ 2: ë©€í‹°í”Œë ˆì´ (P2P Host-Guest)
        // ==========================================
        let peer = null;
        let connections = [];
        let hostConn = null;
        let myId = null;
        let isHost = false;
        
        let GAME = {
            players: [],
            round: 1,
            maxRounds: 3,
            currentTurnIndex: 0,
            state: 'lobby'
        };

        function setupMultiplayer(role) {
            showScreen('screen-lobby');
            
            // ì´ˆê¸°í™”
            if (peer) peer.destroy();
            peer = new Peer(); 
            
            peer.on('open', id => {
                myId = id;
                document.getElementById('my-peer-id').innerText = id;
                
                if (role === 'host') {
                    isHost = true;
                    document.getElementById('host-info').classList.remove('hidden-screen');
                    document.getElementById('host-controls').classList.remove('hidden-screen');
                    document.getElementById('guest-input').classList.add('hidden-screen');
                    document.getElementById('guest-waiting').classList.add('hidden-screen');
                    
                    GAME.players = [{ id: myId, name: "HOST (ë‚˜)", money: 1000, dice:[1,1,1,1,1], rolls:3, bet:0 }];
                    updateLobbyUI();
                } else {
                    isHost = false;
                    document.getElementById('host-info').classList.add('hidden-screen');
                    document.getElementById('host-controls').classList.add('hidden-screen');
                    document.getElementById('guest-input').classList.remove('hidden-screen');
                    document.getElementById('guest-waiting').classList.remove('hidden-screen');
                }
            });

            peer.on('connection', conn => {
                if (isHost) {
                    connections.push(conn);
                    setupDataHandler(conn);
                    
                    const newPlayer = { id: conn.peer, name: `Player ${GAME.players.length + 1}`, money: 1000, dice:[1,1,1,1,1], rolls:3, bet:0 };
                    GAME.players.push(newPlayer);
                    
                    broadcast({ type: 'LOBBY_UPDATE', players: GAME.players });
                    updateLobbyUI();
                }
            });
        }

        function joinRoom() {
            const hostId = document.getElementById('host-id-input').value;
            if (!hostId) return alert("ID ì…ë ¥");
            
            hostConn = peer.connect(hostId);
            hostConn.on('open', () => {
                document.getElementById('guest-input').classList.add('hidden-screen');
                setupDataHandler(hostConn);
            });
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            alert("ID ë³µì‚¬ë¨!");
        }

        function setupDataHandler(conn) {
            conn.on('data', data => {
                if (data.type === 'LOBBY_UPDATE') {
                    GAME.players = data.players;
                    updateLobbyUI();
                }
                else if (data.type === 'GAME_START' || data.type === 'STATE_UPDATE') {
                    GAME = data.gameState;
                    if(data.type === 'GAME_START') showScreen('screen-multi-game');
                    updateGameUI();
                }
                else if (data.type === 'GAME_OVER') {
                    showResult(data.rankings);
                }
                else if (isHost && data.type === 'ACTION') {
                    handlePlayerAction(data.senderId, data.action, data.payload);
                }
            });
        }

        function broadcast(msg) {
            if (isHost) connections.forEach(c => c.send(msg));
        }

        function sendToHost(type, payload) {
            if (isHost) handlePlayerAction(myId, type, payload);
            else hostConn.send({ type: 'ACTION', senderId: myId, action: type, payload: payload });
        }

        function updateLobbyUI() {
            const list = document.getElementById('player-list');
            list.innerHTML = GAME.players.map(p => 
                `<li class="${p.id === myId ? 'text-yellow-400' : ''}">${p.name} ${p.id===myId?'(ë‚˜)':''}</li>`
            ).join('');
            document.getElementById('player-count').innerText = GAME.players.length;
        }

        function setRounds(n) {
            GAME.maxRounds = n;
            document.querySelectorAll('.round-btn').forEach(b => b.classList.remove('bg-blue-600'));
            event.target.classList.add('bg-blue-600');
        }

        function broadcastStart() {
            GAME.state = 'playing';
            GAME.currentTurnIndex = 0;
            GAME.players.forEach(p => { p.dice = [1,2,3,4,5]; p.rolls = 3; p.bet = 0; });
            
            const msg = { type: 'GAME_START', gameState: GAME };
            broadcast(msg);
            showScreen('screen-multi-game');
            updateGameUI();
        }

        // --- ì¸ê²Œì„ UI ---
        function updateGameUI() {
            document.getElementById('multi-round').innerText = `${GAME.round}/${GAME.maxRounds}`;
            const currentPlayer = GAME.players[GAME.currentTurnIndex];
            const isMyTurn = currentPlayer.id === myId;
            
            const turnMsg = document.getElementById('turn-msg');
            if (isMyTurn) {
                turnMsg.innerText = "â­ ë‚˜ì˜ í„´!";
                turnMsg.className = "text-lg font-bold text-black bg-yellow-400 px-4 py-1 rounded-full animate-bounce";
                document.getElementById('my-controls').classList.remove('opacity-50', 'pointer-events-none');
            } else {
                turnMsg.innerText = `${currentPlayer.name}ì˜ í„´...`;
                turnMsg.className = "text-lg font-bold text-white bg-gray-700 px-4 py-1 rounded-full";
                document.getElementById('my-controls').classList.add('opacity-50', 'pointer-events-none');
            }

            const me = GAME.players.find(p => p.id === myId);
            const myDiceContainer = document.getElementById('my-dice-container');
            myDiceContainer.innerHTML = me.dice.map((v, i) => `
                <div class="die die-lg ${isMyTurn && myLocked[i] ? 'locked' : ''}" onclick="toggleLock(${i})">${v}</div>
            `).join('');
            
            const res = evaluate(me.dice);
            document.getElementById('my-hand-rank').innerText = `${res.name} (x${res.mult})`;
            document.getElementById('my-rolls').innerText = me.rolls;
            
            if(!isMyTurn) {
                document.getElementById('my-bet-display').innerText = me.bet;
                document.getElementById('my-bet-slider').value = me.bet;
            }

            const pList = document.getElementById('players-status');
            pList.innerHTML = GAME.players.map(p => `
                <div class="bg-gray-800 border-2 ${p.id === currentPlayer.id ? 'border-yellow-400' : 'border-gray-700'} p-2 rounded mb-2">
                    <div class="flex justify-between items-center text-xs">
                        <span class="font-bold text-white">${p.name}</span>
                        <span class="text-green-400 font-bold">$${p.money.toLocaleString()}</span>
                    </div>
                    <div class="flex gap-1 justify-center mt-1">
                        ${p.dice.map(d => `<div class="w-4 h-4 bg-gray-200 text-black text-[8px] flex items-center justify-center rounded">${d}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // --- ì•¡ì…˜ ---
        let myLocked = [false,false,false,false,false];

        function toggleLock(idx) {
            const currentPlayer = GAME.players[GAME.currentTurnIndex];
            if (currentPlayer.id !== myId || currentPlayer.rolls === 3) return;
            myLocked[idx] = !myLocked[idx];
            updateGameUI();
        }

        document.getElementById('my-bet-slider').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            const me = GAME.players.find(p => p.id === myId);
            if(val > me.money) e.target.value = me.money;
            document.getElementById('my-bet-display').innerText = e.target.value;
        });

        function multiRoll() {
            const me = GAME.players.find(p => p.id === myId);
            if(me.rolls <= 0) return;
            const betVal = parseInt(document.getElementById('my-bet-slider').value);
            if(betVal <= 0) return alert("íˆ¬ìë¥¼ í•˜ì„¸ìš”!");
            sendToHost('ROLL', { locked: myLocked, bet: betVal });
        }

        function multiKeep() {
            const betVal = parseInt(document.getElementById('my-bet-slider').value);
            sendToHost('KEEP', { bet: betVal });
        }

        // --- Host ë¡œì§ ---
        function handlePlayerAction(senderId, action, payload) {
            const pIdx = GAME.players.findIndex(p => p.id === senderId);
            if (pIdx !== GAME.currentTurnIndex) return;

            const player = GAME.players[pIdx];

            if (action === 'ROLL') {
                if (player.rolls > 0) {
                    player.bet = payload.bet;
                    player.rolls--;
                    player.dice = player.dice.map((v, i) => payload.locked[i] ? v : Math.floor(Math.random()*6)+1);
                    broadcast({ type: 'STATE_UPDATE', gameState: GAME });
                }
            }
            else if (action === 'KEEP') {
                const hand = evaluate(player.dice);
                const profit = Math.floor(player.bet * hand.mult);
                player.money = player.money - player.bet + profit;
                player.rolls = 3; player.bet = 0;
                
                GAME.currentTurnIndex++;
                if (GAME.currentTurnIndex >= GAME.players.length) {
                    GAME.currentTurnIndex = 0;
                    GAME.round++;
                    if (GAME.round > GAME.maxRounds) {
                        const rankings = [...GAME.players].sort((a,b) => b.money - a.money);
                        broadcast({ type: 'GAME_OVER', rankings: rankings });
                        showResult(rankings);
                        return;
                    }
                }
                const nextP = GAME.players[GAME.currentTurnIndex];
                nextP.rolls = 3; nextP.bet = 0;
                broadcast({ type: 'STATE_UPDATE', gameState: GAME });
            }
        }

        function showResult(rankings) {
            showScreen('result-modal');
            const div = document.getElementById('rankings');
            div.innerHTML = rankings.map((p, i) => `
                <div class="flex justify-between items-center bg-gray-800 p-4 rounded-xl border ${p.id===myId?'border-blue-500':'border-gray-600'}">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl font-black ${i===0?'text-yellow-400':'text-gray-500'}">#${i+1}</span>
                        <span class="text-white font-bold text-xl">${p.name}</span>
                    </div>
                    <span class="text-2xl text-green-400 font-bold">$${p.money.toLocaleString()}</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
