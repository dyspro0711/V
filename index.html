<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² Dice Vestor: Short ID</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --glass-bg: rgba(30, 41, 59, 0.95); --glass-border: rgba(255, 255, 255, 0.1); }
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Noto Sans KR', sans-serif; user-select: none; overflow: hidden; background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.1) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%); }
        .bg-grid { position: absolute; inset: 0; z-index: 0; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none; }
        .font-title { font-family: 'Russo One', sans-serif; letter-spacing: 1px; }
        .hidden-screen { display: none !important; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); position: relative; z-index: 10; }
        .die { width: 55px; height: 55px; background: linear-gradient(145deg, #f8fafc, #cbd5e1); color: #1e293b; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #fff; }
        .die:hover { transform: translateY(-2px); }
        .die.locked { background: linear-gradient(145deg, #ef4444, #b91c1c); color: white; border-color: #fca5a5; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); transform: translateY(2px); }
        .die-lg { width: 75px; height: 75px; font-size: 2.5rem; }
        .rolling { animation: roll-shake 0.4s infinite; }
        @keyframes roll-shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        .btn-glow { position: relative; overflow: hidden; transition: all 0.2s; z-index: 50; cursor: pointer; }
        .btn-glow:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .btn-glow:active { transform: translateY(0); filter: brightness(0.9); }
        .btn-glow:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); transform: none; }
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(255,255,255,0.1); color: #94a3b8; padding: 8px 16px; border-radius: 999px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 6px; }
        .back-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .chat-bubble { padding: 6px 10px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 6px; word-break: break-all; }
        .chat-system { color: #fbbf24; font-size: 0.75rem; text-align: center; margin: 8px 0; opacity: 0.8; }
        .chat-mine { background: #3b82f6; color: white; align-self: flex-end; margin-left: 20%; text-align: right; }
        .chat-other { background: #334155; color: #e2e8f0; align-self: flex-start; margin-right: 20%; text-align: left; }
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; position: relative; z-index: 20; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #10b981; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    </style>
</head>
<body class="h-screen flex items-center justify-center relative overflow-hidden">

    <div class="bg-grid"></div>

    <button id="global-back-btn" class="back-btn hidden-screen" onclick="goToMain()">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg> ë©”ì¸ìœ¼ë¡œ
    </button>

    <div id="screen-menu" class="glass-panel w-full max-w-md p-10 rounded-3xl text-center relative z-50">
        <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-500 rounded-full blur-[80px] opacity-30 pointer-events-none"></div>
        <h1 class="text-6xl font-title text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 mb-2 drop-shadow-sm">DICE VESTOR</h1>
        <p class="text-gray-400 mb-10 text-sm tracking-wide">íˆ¬ì & í™•ë¥  ì „ëµ ê²Œì„</p>
        <div class="space-y-4 relative z-50">
            <button onclick="startSinglePlayer()" class="btn-glow w-full py-5 bg-gradient-to-r from-slate-700 to-slate-800 border border-slate-600 text-white font-bold rounded-2xl text-lg flex items-center justify-between px-6 group">
                <div class="text-left"><span class="block group-hover:text-blue-300 transition">ğŸ‘¤ ê°œì¸ í”Œë ˆì´</span><span class="text-[11px] text-gray-400">ì‹±ê¸€ ëª¨ë“œ (ê¸°ë¡ ë„ì „)</span></div><span class="text-2xl">ğŸ†</span>
            </button>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="setupMultiplayer('host')" class="btn-glow py-5 bg-gradient-to-br from-green-900/80 to-green-800/80 border border-green-700 hover:border-green-400 text-white font-bold rounded-2xl flex flex-col items-center justify-center gap-1 group">
                    <span class="text-2xl">ğŸ </span><span>ë°© ë§Œë“¤ê¸°</span><span class="text-[10px] text-green-300/70">Host</span>
                </button>
                <button onclick="setupMultiplayer('guest')" class="btn-glow py-5 bg-gradient-to-br from-purple-900/80 to-purple-800/80 border border-purple-700 hover:border-purple-400 text-white font-bold rounded-2xl flex flex-col items-center justify-center gap-1 group">
                    <span class="text-2xl">ğŸ”—</span><span>ì°¸ê°€í•˜ê¸°</span><span class="text-[10px] text-purple-300/70">Guest</span>
                </button>
            </div>
        </div>
    </div>

    <div id="screen-game" class="hidden-screen w-full max-w-7xl p-4 flex gap-6 h-[800px] pt-16 relative z-10">
        <div class="w-3/4 glass-panel rounded-3xl p-8 flex flex-col relative shadow-2xl">
            <div class="flex justify-between items-start mb-8">
                <div class="flex flex-col"><span class="text-xs text-gray-400 font-mono">ROUND</span><span class="text-3xl font-title text-white"><span id="game-round">1</span> <span class="text-gray-600 text-xl">/ <span id="game-max-rounds">10</span></span></span></div>
                <div id="turn-indicator" class="hidden text-lg font-bold text-gray-400 bg-black/30 px-6 py-2 rounded-full border border-white/5">ëŒ€ê¸°ì¤‘...</div>
                <div id="single-highscore" class="hidden text-right"><span class="text-xs text-yellow-500 font-bold tracking-widest">HIGH SCORE</span><div class="text-2xl font-bold text-white">$<span id="best-score-disp">0</span></div></div>
            </div>
            <div class="flex-1 flex flex-col items-center justify-center">
                <div class="flex gap-6 mb-10" id="dice-container">
                    <div class="die die-lg" onclick="toggleLock(0)">1</div>
                    <div class="die die-lg" onclick="toggleLock(1)">2</div>
                    <div class="die die-lg" onclick="toggleLock(2)">3</div>
                    <div class="die die-lg" onclick="toggleLock(3)">4</div>
                    <div class="die die-lg" onclick="toggleLock(4)">5</div>
                </div>
                <div class="text-5xl font-title text-yellow-400 h-16 drop-shadow-md tracking-wider" id="hand-rank">-</div>
                <div class="text-xl font-bold text-green-400" id="hand-mult">x0.0</div>
            </div>
            <div id="control-panel" class="mt-auto transition duration-300 bg-black/20 p-6 rounded-2xl border border-white/5">
                <div class="mb-6">
                    <div class="flex justify-between text-xs text-gray-400 mb-2 font-bold uppercase tracking-wider"><span>í˜„ì¬ ìì‚°: $<span id="current-money">1,000</span></span><span class="text-green-400 text-lg">íˆ¬ì: $<span id="bet-display">0</span></span></div>
                    <input type="range" id="bet-slider" class="w-full" min="0" max="1000" step="10">
                    <div class="flex justify-between text-[10px] text-gray-500 mt-1"><span>0%</span><span>50%</span><span>100%</span></div>
                </div>
                <div class="flex gap-4">
                    <button id="btn-roll" onclick="actionRoll()" class="btn-glow flex-1 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl text-xl shadow-lg">ROLL (<span id="rolls-left">3</span>)</button>
                    <button id="btn-keep" onclick="actionKeep()" class="btn-glow flex-1 py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl text-xl shadow-lg">KEEP</button>
                </div>
            </div>
        </div>
        <div id="sidebar" class="w-1/4 glass-panel rounded-3xl flex flex-col p-4">
            <div class="flex border-b border-white/10 mb-2">
                <button id="tab-btn-chat" class="flex-1 py-2 text-xs font-bold text-white border-b-2 border-blue-500" onclick="switchTab('chat')">ğŸ’¬ ì±„íŒ…</button>
                <button id="tab-btn-status" class="flex-1 py-2 text-xs font-bold text-gray-500" onclick="switchTab('status')">ğŸ‘¥ í˜„í™©</button>
                <button id="tab-btn-stats" class="flex-1 py-2 text-xs font-bold text-gray-500 hidden" onclick="switchTab('stats')">ğŸ“Š í†µê³„</button>
            </div>
            <div id="tab-chat" class="flex-1 flex flex-col h-full">
                <div id="chat-history" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col p-2 space-y-2 text-sm h-0"><div class="chat-system">ê²Œì„ ëŒ€ê¸°ì¤‘...</div></div>
                <div id="chat-input-area" class="mt-2 flex gap-2 hidden-screen">
                    <input type="text" id="chat-msg" class="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm text-white outline-none" placeholder="ë©”ì‹œì§€..." onkeypress="if(event.key==='Enter') sendChat()">
                    <button onclick="sendChat()" class="bg-blue-600 text-white px-3 rounded-lg text-sm font-bold hover:bg-blue-500">ì „ì†¡</button>
                </div>
            </div>
            <div id="tab-status" class="hidden-screen flex-1 overflow-y-auto custom-scrollbar space-y-2 p-1"></div>
            <div id="tab-stats" class="hidden-screen flex-1 flex flex-col p-1">
                <div class="flex-1 bg-black/20 rounded-xl p-2 relative h-48"><canvas id="statChart"></canvas></div>
                <p class="text-center text-[10px] text-gray-500 mt-2">ì´ë¡ (16.6%) vs ì‹¤í—˜ í™•ë¥ </p>
                <div class="text-center text-xs text-white mt-2">ì´ ì‹œí–‰: <span id="total-rolls">0</span></div>
            </div>
        </div>
    </div>

    <div id="screen-lobby" class="hidden-screen glass-panel w-full max-w-md p-8 rounded-3xl text-center mt-10 relative z-50">
        <h2 class="text-3xl font-title text-white mb-6">LOBBY</h2>
        <div id="host-ui" class="hidden-screen mb-6">
            <div class="bg-black/40 p-4 rounded-xl border border-white/10 mb-4">
                <p class="text-xs text-gray-400 mb-1">ì´ˆëŒ€ ì½”ë“œ (ì¹œêµ¬ì—ê²Œ ì•Œë ¤ì£¼ì„¸ìš”)</p>
                <div class="flex items-center justify-center gap-2">
                    <span id="my-peer-id" class="text-3xl font-title text-yellow-400 select-all tracking-widest">...</span>
                    <button onclick="copyId()" class="text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20">ë³µì‚¬</button>
                </div>
            </div>
            <div class="flex justify-center gap-2 mb-4">
                <button onclick="setRounds(3)" class="round-btn bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">3R</button>
                <button onclick="setRounds(5)" class="round-btn bg-gray-600 text-gray-400 px-3 py-1 rounded text-xs font-bold">5R</button>
                <button onclick="setRounds(10)" class="round-btn bg-gray-600 text-gray-400 px-3 py-1 rounded text-xs font-bold">10R</button>
            </div>
            <button id="start-game-btn" onclick="broadcastStart()" class="btn-glow w-full py-3 bg-green-600 text-white font-bold rounded-xl disabled:opacity-50" disabled>ê²Œì„ ì‹œì‘</button>
        </div>
        <div id="guest-ui" class="hidden-screen mb-6">
            <input type="text" id="host-id-input" placeholder="ì½”ë“œ ì…ë ¥ (ì˜ˆ: A1B2)" class="w-full p-4 bg-black/30 border border-white/10 rounded-xl text-center text-white text-xl font-bold uppercase mb-3 outline-none tracking-widest">
            <button id="join-btn" onclick="joinRoom()" class="btn-glow w-full py-3 bg-purple-600 text-white font-bold rounded-xl">ì—°ê²°í•˜ê¸°</button>
            <p id="guest-status" class="mt-2 text-yellow-400 text-xs animate-pulse hidden-screen">ëŒ€ê¸°ì¤‘...</p>
        </div>
        <div class="text-left bg-black/20 p-4 rounded-xl">
            <p class="text-xs text-gray-400 mb-2">ì ‘ì†ì (<span id="player-count">1</span>/4)</p>
            <ul id="player-list" class="space-y-1 text-sm font-bold text-white"></ul>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center hidden-screen">
        <h1 class="text-7xl font-title text-yellow-400 mb-8">GAME OVER</h1>
        <div id="rankings" class="w-full max-w-lg space-y-3 mb-10"></div>
        <button onclick="goToMain()" class="btn-glow px-10 py-4 bg-white text-black font-bold rounded-full hover:bg-gray-200">ë©”ì¸ìœ¼ë¡œ</button>
    </div>

    <script>
        // ==========================================
        // 0. ì „ì—­ ì„¤ì • & ID ìƒì„± ìœ í‹¸
        // ==========================================
        let MODE = 'single';
        let GAME = { 
            players: [], round: 1, maxRounds: 10, turnIdx: 0, state: 'lobby',
            money: 1000, bet: 0, dice: [1,2,3,4,5], locked: [false,false,false,false,false], rolls: 3, 
            myId: 'single_player', isHost: false 
        };
        let peer = null, connections = [], hostConn = null;
        let singleStats = [0,0,0,0,0,0], singleTotal = 0, myChart = null;

        // [ìˆ˜ì •] 4~5ìë¦¬ ëœë¤ ID ìƒì„± í•¨ìˆ˜ (ëŒ€ë¬¸ì+ìˆ«ì)
        function generateShortId() {
            return Math.random().toString(36).substr(2, 5).toUpperCase();
        }
        
        // ì¡±ë³´ ë¡œì§ (ë¼ì§€/ìŠ¤ëª° ìŠ¤íŠ¸ë ˆì´íŠ¸ í¬í•¨)
        function getUniqueStr(d) { return [...new Set(d)].sort((a,b)=>a-b).join(''); }
        const HANDS = [
            { name: "Yacht", mult: 10, check: d=>hasKind(d,5) }, 
            { name: "4 Kind", mult: 5, check: d=>hasKind(d,4) },
            { name: "Full House", mult: 3, check: d=>isFullHouse(d) },
            { name: "L-Straight (2-6)", mult: 5.0, check: d => getUniqueStr(d) === '23456' },
            { name: "L-Straight (1-5)", mult: 4.0, check: d => getUniqueStr(d) === '12345' },
            { name: "S-Straight (3-6)", mult: 2.5, check: d => getUniqueStr(d).includes('3456') },
            { name: "S-Straight (2-5)", mult: 2.2, check: d => getUniqueStr(d).includes('2345') },
            { name: "S-Straight (1-4)", mult: 2.0, check: d => getUniqueStr(d).includes('1234') },
            { name: "3 Kind", mult: 1.5, check: d=>hasKind(d,3) }, 
            { name: "2 Pair", mult: 1.0, check: d=>isTwoPair(d) },
            { name: "1 Pair", mult: 0.5, check: d=>hasKind(d,2) }, 
            { name: "No Pair", mult: 0, check: d=>true }
        ];

        function evaluate(d) { return HANDS.find(h => h.check(d)); }
        function hasKind(d,n){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);return Object.values(c).some(v=>v>=n);}
        function isFullHouse(d){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);const v=Object.values(c);return (v.includes(3)&&v.includes(2))||v.includes(5);}
        function isTwoPair(d){const c={};d.forEach(x=>c[x]=(c[x]||0)+1);return Object.values(c).filter(v=>v>=2).length>=2;}

        function showScreen(id) {
            ['screen-menu', 'screen-lobby', 'screen-game', 'result-modal'].forEach(s => document.getElementById(s).classList.add('hidden-screen'));
            document.getElementById(id).classList.remove('hidden-screen');
            const backBtn = document.getElementById('global-back-btn');
            if(id === 'screen-menu') backBtn.classList.add('hidden-screen');
            else backBtn.classList.remove('hidden-screen');
        }

        function goToMain() {
            if(peer) { peer.destroy(); peer = null; }
            connections = []; hostConn = null;
            document.getElementById('chat-history').innerHTML = '<div class="chat-system">ëŒ€ê¸°ì¤‘...</div>';
            showScreen('screen-menu');
        }

        function switchTab(tab) {
            ['chat', 'status', 'stats'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden-screen');
                const btn = document.getElementById(`tab-btn-${t}`);
                if(btn) { btn.classList.remove('border-blue-500', 'text-white'); btn.classList.add('text-gray-500'); }
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden-screen');
            const activeBtn = document.getElementById(`tab-btn-${tab}`);
            if(activeBtn) { activeBtn.classList.remove('text-gray-500'); activeBtn.classList.add('border-blue-500', 'text-white'); }
        }

        // ==========================================
        // 1. ì‹±ê¸€ í”Œë ˆì´
        // ==========================================
        function startSinglePlayer() {
            MODE = 'single';
            GAME.round = 1; GAME.maxRounds = 10; GAME.money = 1000; GAME.bet = 0; GAME.myId = 'single_player';
            resetTurn();
            document.getElementById('single-highscore').classList.remove('hidden-screen');
            document.getElementById('chat-input-area').classList.add('hidden-screen');
            document.getElementById('turn-indicator').classList.add('hidden');
            document.getElementById('tab-btn-stats').classList.remove('hidden');
            const best = localStorage.getItem('dv_highscore') || 0;
            document.getElementById('best-score-disp').innerText = parseInt(best).toLocaleString();
            document.getElementById('tab-status').innerHTML = `
                <div class="bg-gray-800 p-3 rounded border border-blue-500 flex justify-between"><span class="text-white font-bold">ë‚˜ (ME)</span><span class="text-green-400 font-bold">$1,000</span></div>`;
            if(!myChart) initChart();
            switchTab('chat');
            document.getElementById('chat-history').innerHTML = '<div class="chat-system">ê²Œì„ ë¡œê·¸ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</div>';
            showScreen('screen-game');
            updateUI();
        }

        function initChart() {
            const ctx = document.getElementById('statChart').getContext('2d');
            myChart = new Chart(ctx, { type: 'bar', data: { labels:['1','2','3','4','5','6'], datasets:[{ label:'ì‹¤í—˜ (%)', data:[0,0,0,0,0,0], backgroundColor:'#3b82f6'}, {type:'line', label:'ì´ë¡  (16.6%)', data:[16.6,16.6,16.6,16.6,16.6,16.6], borderColor:'#fbbf24', borderDash:[5,5]}] }, options:{ responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, max:40}}, plugins:{legend:{labels:{color:'white'}}} } });
        }
        function updateChart() {
            if(singleTotal>0) myChart.data.datasets[0].data = singleStats.map(v=>(v/singleTotal*100).toFixed(1));
            myChart.update();
            document.getElementById('total-rolls').innerText = singleTotal;
        }

        // ==========================================
        // 2. ë©€í‹° í”Œë ˆì´ (ì§§ì€ ID ì ìš©)
        // ==========================================
        function setupMultiplayer(role) {
            MODE = 'multi';
            document.getElementById('tab-btn-stats').classList.add('hidden');
            showScreen('screen-lobby');
            if(peer) peer.destroy();
            
            // [ìˆ˜ì •] ì§§ì€ ID ìƒì„±
            const shortId = generateShortId();
            peer = new Peer(shortId, { debug: 1 }); // ì§§ì€ ID ì‚¬ìš©
            
            peer.on('open', id => {
                GAME.myId = id;
                document.getElementById('my-peer-id').innerText = id;
                if(role === 'host') {
                    GAME.isHost = true;
                    document.getElementById('host-ui').classList.remove('hidden-screen');
                    document.getElementById('guest-ui').classList.add('hidden-screen');
                    GAME.players = [{id:id, name:"ë°©ì¥(ë‚˜)", money:1000, dice:[1,1,1,1,1], rolls:3, bet:0}];
                    updateLobbyList();
                } else {
                    GAME.isHost = false;
                    document.getElementById('host-ui').classList.add('hidden-screen');
                    document.getElementById('guest-ui').classList.remove('hidden-screen');
                    const btn = document.getElementById('join-btn');
                    btn.disabled = false; btn.innerText = "ì—°ê²°í•˜ê¸°"; btn.classList.remove('opacity-50');
                    document.getElementById('guest-status').classList.add('hidden-screen');
                }
            });

            // ID ì¤‘ë³µ ì—ëŸ¬ ì²˜ë¦¬ (ì•„ì£¼ ë“œë¬¸ ê²½ìš°)
            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    alert("ID ìƒì„± ì¶©ëŒ! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    setupMultiplayer(role); // ì¬ì‹œë„
                } else {
                    console.error(err);
                }
            });

            peer.on('connection', conn => {
                if(GAME.isHost) {
                    setupConn(conn);
                }
            });
        }

        function joinRoom() {
            let hostId = document.getElementById('host-id-input').value.trim().toUpperCase(); // ëŒ€ë¬¸ì ë³€í™˜
            if(!hostId) return alert("ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            
            const btn = document.getElementById('join-btn');
            btn.disabled = true; btn.classList.add('opacity-50'); btn.innerText = "ì—°ê²° ì‹œë„ ì¤‘...";
            document.getElementById('guest-status').classList.remove('hidden-screen');
            document.getElementById('guest-status').innerText = "ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ íƒìƒ‰ ì¤‘... (ìµœëŒ€ 10ì´ˆ)";

            hostConn = peer.connect(hostId, { reliable: true });

            hostConn.on('open', () => {
                document.getElementById('guest-status').innerText = "âœ… ì„œë²„ ë°œê²¬! ì…ì¥ ìš”ì²­ ì¤‘...";
                setupConn(hostConn);
                hostConn.send({type:'JOIN_REQ', name: `ê²ŒìŠ¤íŠ¸ ${Math.floor(Math.random()*100)}`});
            });

            // 5ì´ˆ í›„ì—ë„ ì—°ê²° ì•ˆë˜ë©´ íŒíŠ¸ ì œê³µ
            setTimeout(() => {
                if(btn.disabled && document.getElementById('guest-status').innerText.includes('íƒìƒ‰ ì¤‘')) {
                     document.getElementById('guest-status').innerText = "âš ï¸ ì—°ê²°ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤... (ë°©í™”ë²½ í™•ì¸)";
                }
            }, 5000);

            hostConn.on('error', (e) => {
                alert("ì—°ê²° ì‹¤íŒ¨: " + e);
                btn.disabled = false; btn.classList.remove('opacity-50'); btn.innerText = "ì—°ê²°í•˜ê¸°";
                document.getElementById('guest-status').classList.add('hidden-screen');
            });
        }

        function setupConn(conn) {
            conn.on('data', data => {
                if (GAME.isHost && data.type === 'JOIN_REQ') {
                    if(GAME.state !== 'lobby') return conn.close();
                    if(GAME.players.some(p => p.id === conn.peer)) return;
                    const newPlayer = {id:conn.peer, name: `User ${GAME.players.length+1}`, money:1000, dice:[1,1,1,1,1], rolls:3, bet:0};
                    GAME.players.push(newPlayer);
                    connections.push(conn);
                    broadcast({type:'LOBBY_UPDATE', players:GAME.players});
                    updateLobbyList();
                    return;
                }

                if(data.type === 'CHAT') addChatMessage(data.sender, data.text, false);
                else if(data.type === 'LOBBY_UPDATE') { 
                    GAME.players = data.players; 
                    updateLobbyList(); 
                    document.getElementById('guest-status').innerText = "ğŸ‰ ì…ì¥ ì™„ë£Œ! ê²Œì„ ëŒ€ê¸° ì¤‘...";
                }
                else if(data.type === 'GAME_START') { 
                    const savedId = GAME.myId; const savedHost = GAME.isHost;
                    GAME = data.state; GAME.myId = savedId; GAME.isHost = savedHost;
                    startMultiGame(); 
                }
                else if(data.type === 'STATE_UPDATE') { 
                    const savedId = GAME.myId; const savedHost = GAME.isHost;
                    GAME = data.state; GAME.myId = savedId; GAME.isHost = savedHost;
                    updateUI();
                }
                else if(data.type === 'GAME_OVER') { showResult(data.rankings); }
                else if(GAME.isHost && data.type === 'ACTION') handleHostAction(data.senderId, data.action, data.payload);
            });
        }

        function broadcast(msg) { 
            if(GAME.isHost) connections.forEach(c => { if(c.open) c.send(msg); });
        }
        function sendAction(act, pl) {
            if(GAME.isHost) handleHostAction(GAME.myId, act, pl);
            else hostConn.send({type:'ACTION', senderId:GAME.myId, action:act, payload:pl});
        }

        function updateLobbyList() {
            document.getElementById('player-list').innerHTML = GAME.players.map(p => `<li class="${p.id===GAME.myId?'text-yellow-400':''}">${p.name}</li>`).join('');
            document.getElementById('player-count').innerText = GAME.players.length;
            if(GAME.isHost) {
                const btn = document.getElementById('start-game-btn');
                if(GAME.players.length >= 2) { btn.disabled = false; btn.classList.remove('opacity-50'); }
                else { btn.disabled = true; btn.classList.add('opacity-50'); }
            }
        }

        function setRounds(n) { GAME.maxRounds = n; document.querySelectorAll('.round-btn').forEach(b => b.classList.replace('bg-blue-600','bg-gray-600')); event.target.classList.replace('bg-gray-600','bg-blue-600'); }
        
        function broadcastStart() {
            GAME.state = 'playing';
            GAME.turnIdx = 0; GAME.round = 1;
            GAME.players.forEach(p => { p.money=1000; p.dice=[1,2,3,4,5]; p.rolls=3; p.bet=0; });
            const state = JSON.parse(JSON.stringify(GAME));
            broadcast({type:'GAME_START', state:state});
            startMultiGame();
        }

        function startMultiGame() {
            showScreen('screen-game');
            document.getElementById('single-highscore').classList.add('hidden-screen');
            document.getElementById('chat-input-area').classList.remove('hidden-screen');
            document.getElementById('turn-indicator').classList.remove('hidden');
            document.getElementById('chat-history').innerHTML = '<div class="chat-system">ê²Œì„ ì‹œì‘!</div>';
            switchTab('chat');
            updateUI();
        }

        // ==========================================
        // 3. ì¸ê²Œì„ ì•¡ì…˜
        // ==========================================
        function resetTurn() {
            GAME.dice = [1,2,3,4,5]; GAME.locked = [false,false,false,false,false]; GAME.rolls = 3; GAME.bet = 0;
            document.getElementById('bet-slider').value = 0; document.getElementById('bet-slider').disabled = false;
        }

        function actionRoll() {
            if(MODE === 'multi' && !isMyTurn()) return;
            
            let currentRolls = GAME.rolls;
            if (MODE === 'multi') {
                const me = GAME.players.find(p => p.id === GAME.myId);
                if (me) currentRolls = me.rolls;
            }

            if(currentRolls <= 0) return;
            
            const bet = parseInt(document.getElementById('bet-slider').value);
            if(bet <= 0) return alert("íˆ¬ìë¥¼ í•˜ì„¸ìš”!");
            if(bet > GAME.money) return alert("ìê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            
            if(MODE === 'single') {
                GAME.bet = bet; GAME.rolls--; localRoll();
                document.getElementById('bet-slider').disabled = true; updateUI();
            } else {
                sendAction('ROLL', {bet:bet, locked:GAME.locked});
            }
        }

        function actionKeep() {
            if(MODE === 'multi' && !isMyTurn()) return;
            if(MODE === 'single') {
                if(GAME.bet === 0) return alert("ê²Œì„ ì§„í–‰ ì•ˆë¨");
                const h = evaluate(GAME.dice); const prof = Math.floor(GAME.bet * h.mult); const net = prof - GAME.bet;
                GAME.money += net;
                addChatMessage('ì‹œìŠ¤í…œ', `ë¼ìš´ë“œ ${GAME.round}: ${net>=0?'+':''}${net} (${h.name})`, false);
                GAME.round++;
                if(GAME.round > GAME.maxRounds) {
                    const best = Math.max(GAME.money, parseInt(localStorage.getItem('dv_highscore')||0));
                    localStorage.setItem('dv_highscore', best); showResult([{name:'ë‚˜', money:GAME.money}]);
                } else {
                    resetTurn(); updateUI();
                }
            } else {
                const bet = parseInt(document.getElementById('bet-slider').value); sendAction('KEEP', {bet:bet});
            }
        }

        function localRoll() {
            const els = document.querySelectorAll('.die');
            els.forEach((el,i) => { if(!GAME.locked[i]) el.classList.add('rolling'); });
            setTimeout(() => {
                GAME.dice = GAME.dice.map((v,i) => {
                    if(GAME.locked[i]) return v;
                    const r = Math.floor(Math.random()*6)+1;
                    singleStats[r-1]++; singleTotal++; return r;
                });
                els.forEach(el => el.classList.remove('rolling')); updateUI(); updateChart();
            }, 400);
        }

        function toggleLock(i) {
            if(MODE==='multi' && !isMyTurn()) return;
            let currentRolls = GAME.rolls;
            if (MODE === 'multi') {
                const me = GAME.players.find(p => p.id === GAME.myId);
                if (me) currentRolls = me.rolls;
            }
            if(currentRolls === 3) return;
            GAME.locked[i] = !GAME.locked[i]; updateUI();
        }

        function updateUI() {
            const isSingle = MODE === 'single';
            const me = isSingle ? GAME : GAME.players.find(p=>p.id===GAME.myId);
            const curP = isSingle ? GAME : GAME.players[GAME.turnIdx];
            const isMe = isSingle ? true : curP.id === GAME.myId;

            document.getElementById('game-round').innerText = GAME.round;
            document.getElementById('game-max-rounds').innerText = GAME.maxRounds;
            document.getElementById('current-money').innerText = me.money.toLocaleString();
            const ind = document.getElementById('turn-indicator');
            const controls = document.getElementById('control-panel');
            
            if(!isSingle) {
                if(isMe) {
                    ind.innerText = "â­ ë‚˜ì˜ í„´"; ind.className = "text-lg font-bold text-black bg-yellow-400 px-6 py-2 rounded-full animate-bounce";
                    controls.classList.remove('opacity-50', 'pointer-events-none');
                } else {
                    ind.innerText = `${curP.name} í„´...`; ind.className = "text-lg font-bold text-gray-400 bg-gray-700 px-6 py-2 rounded-full border border-gray-600";
                    controls.classList.add('opacity-50', 'pointer-events-none');
                }
            } else { controls.classList.remove('opacity-50', 'pointer-events-none'); }

            const displayDice = isSingle ? GAME.dice : curP.dice;
            const displayLocked = isSingle ? GAME.locked : (isMe ? GAME.locked : [false,false,false,false,false]);
            document.getElementById('dice-container').innerHTML = displayDice.map((v, i) => `
                <div class="die die-lg ${displayLocked[i] ? 'locked' : ''}" onclick="toggleLock(${i})">${v}</div>
            `).join('');
            const res = evaluate(displayDice);
            document.getElementById('hand-rank').innerText = res.name;
            document.getElementById('hand-mult').innerText = `x${res.mult}`;
            document.getElementById('rolls-left').innerText = isSingle ? GAME.rolls : curP.rolls;
            if(!isMe && !isSingle) { document.getElementById('bet-display').innerText = curP.bet; } 
            else { const s = document.getElementById('bet-slider'); s.max = me.money; document.getElementById('bet-display').innerText = s.value; }

            if(!isSingle) {
                document.getElementById('tab-status').innerHTML = GAME.players.map(p => `
                    <div class="bg-gray-800 p-2 rounded border ${p.id===curP.id ? 'border-yellow-400' : 'border-gray-600'} mb-2">
                        <div class="flex justify-between text-xs font-bold text-white"><span>${p.name}</span><span>$${p.money.toLocaleString()}</span></div>
                        <div class="flex gap-1 justify-center mt-1">${p.dice.map(d=>`<span class="w-4 h-4 bg-gray-600 rounded flex items-center justify-center text-[10px]">${d}</span>`).join('')}</div>
                    </div>`).join('');
            }
        }

        function handleHostAction(pid, act, pl) {
            if(act === 'CHAT') { broadcast({type:'CHAT', sender:pl.name, text:pl.text}); addChatMessage(pl.name, pl.text, false); return; }
            const pIdx = GAME.players.findIndex(p=>p.id===pid);
            if(pIdx !== GAME.turnIdx) return;
            const p = GAME.players[pIdx];

            if(act === 'ROLL') {
                if(p.rolls > 0) {
                    p.bet = pl.bet; p.rolls--; p.dice = p.dice.map((v, i) => pl.locked[i] ? v : Math.floor(Math.random()*6)+1);
                    broadcast({type:'STATE_UPDATE', state:GAME}); if(GAME.isHost) updateUI();
                }
            } else if(act === 'KEEP') {
                const res = evaluate(p.dice); const prof = Math.floor(p.bet * res.mult); const net = prof - p.bet;
                p.money += net;
                broadcast({type:'CHAT', sender:'ì‹œìŠ¤í…œ', text:`${p.name}: ${net>=0?'+':''}${net} (${res.name})`});
                p.rolls=3; p.bet=0; GAME.locked=[false,false,false,false,false];
                GAME.turnIdx++;
                if(GAME.turnIdx >= GAME.players.length) {
                    GAME.turnIdx = 0; GAME.round++;
                    if(GAME.round > GAME.maxRounds) {
                        const ranks = [...GAME.players].sort((a,b)=>b.money-a.money);
                        broadcast({type:'GAME_OVER', rankings:ranks}); showResult(ranks); return;
                    }
                }
                const nextP = GAME.players[GAME.turnIdx]; nextP.rolls=3; nextP.bet=0;
                broadcast({type:'STATE_UPDATE', state:GAME}); if(GAME.isHost) updateUI();
            }
        }

        function isMyTurn() { return GAME.players[GAME.turnIdx].id === GAME.myId; }
        function copyId() { navigator.clipboard.writeText(GAME.myId); alert("ë³µì‚¬ë¨"); }
        document.getElementById('bet-slider').addEventListener('input', e => {
            const val = parseInt(e.target.value); const me = MODE==='single' ? GAME : GAME.players.find(p=>p.id===GAME.myId);
            if(val > me.money) e.target.value = me.money;
            document.getElementById('bet-display').innerText = e.target.value;
        });
        function showResult(ranks) {
            showScreen('result-modal');
            document.getElementById('rankings').innerHTML = ranks.map((p,i) => `
                <div class="flex justify-between bg-gray-800 p-4 rounded-xl border border-gray-600">
                    <span class="text-2xl font-bold text-yellow-400">#${i+1}</span>
                    <span class="text-white">${p.name}</span>
                    <span class="text-green-400 font-bold">$${p.money.toLocaleString()}</span>
                </div>`).join('');
        }
        function sendChat() {
            const input = document.getElementById('chat-msg'); const txt = input.value.trim(); if(!txt) return;
            const name = MODE==='single' ? 'ë‚˜' : GAME.players.find(p=>p.id===GAME.myId)?.name;
            addChatMessage(name, txt, true);
            if(MODE==='multi') {
                if(GAME.isHost) broadcast({type:'CHAT', sender:name, text:txt});
                else hostConn.send({type:'ACTION', senderId:GAME.myId, action:'CHAT', payload:{name:name, text:txt}});
            }
            input.value = '';
        }
        function addChatMessage(sender, text, mine) {
            const box = document.getElementById('chat-history'); const d = document.createElement('div');
            d.className = `chat-bubble ${mine?'chat-mine':'chat-other'}`; d.innerHTML = `<strong>${sender}</strong><br>${text}`;
            box.appendChild(d); box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
